# 2025-10-02 推荐与摘要真实数据测试计划
Status: Completed
Last-updated: 2025-10-02

## 背景与现状
- 迁移后的真实数据已写入 `data/`，但现有推荐测试主要依赖构造数据，无法验证新数据链路。
- 示例配置使用 `env:VAR` 形式标记密钥，目前代码层面对其解析行为尚未验证。
- 摘要流水线仍基于 stub LLM，但需要在测试中确认在本地已有密钥时可完整走通流程。

## 风险评估
- 真实数据体量较大，若直接加载可能导致测试耗时过长或内存压力过大。
- 偏好数据与嵌入数据可能存在缺口（如缺失 embedding、偏好为非 like 标签），导致模型训练失败。
- `env:VAR` 解析若处理不当，可能在无密钥环境下引发测试误报。

## 方案概览
1. 抽取真实数据子集：按配置类别筛选 2025 年数据，补齐 `jasper_v1`、`conan_v1` 向量并过滤 NaN，构建测试专用缓存与偏好目录。
2. 为 LLM 配置提供统一的 `env:` 解析辅助函数，并在摘要生成器初始化时校验所需密钥是否存在。
3. 新增集成测试：
   - 验证推荐流水线在真实数据子集下能训练模型并产出评分结果。
   - 若检测到目标 LLM 密钥存在，则对得分最高的论文执行摘要，检查产物。

## 回滚策略
- 如真实数据采样逻辑导致测试不稳定，可删除新增测试文件并移除相关帮助函数。
- 若 `env:` 解析影响其他模块，回滚至新增辅助函数前的提交，恢复原有常量行为。

## 执行记录
- 2025-10-02：实现 `resolve_env_reference` 辅助函数并在摘要流水线中校验密钥，准备真实数据子集用于测试，新增集成用例；执行 `uv run --no-progress pytest tests/config/test_llm_config.py tests/recommend/test_integration.py`，推荐用例通过、摘要用例在无密钥时自动跳过。
- 2025-10-02：根据可用的 LLM 环境变量动态选择摘要模型，并在本地设置 `GEMINI_API_KEY` 后执行 `GEMINI_API_KEY=dummy uv run --no-progress pytest tests/recommend/test_integration.py`，推荐与摘要流程均通过。
