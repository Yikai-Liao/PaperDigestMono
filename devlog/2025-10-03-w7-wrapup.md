# 2025-10-03 W7: 迁移工具、备份 & 收尾实施记录

Status: Completed  
Last-updated: 2025-10-04  
Author: Roo (AI Assistant)

## 实施背景
根据 `devlog/2025-10-03-migration-plan.md` 中的 W7 计划，本周目标是完善迁移/备份工具，并完成项目收尾。主要任务包括：
- LegacyMigrator 扩展：增强现有 `papersys/migration/legacy.py` 支持 publishing/feedback 数据迁移，添加 dry-run 验证。
- BackupService 测试：扩展 `tests/backup/test_backup_service.py` 覆盖新数据类型 (summaries, preferences, content)。
- CI pytest + dry-run：配置 pytest for CI (e.g., GitHub Actions yaml)，添加 dry-run 模式测试。
- 脚本：`scripts/migrate_reference_data.py` (CLI for LegacyMigrator)；`scripts/run_backup_sample.py` (backup 示例)。

依赖：W1-W6 模块；`devlog/2025-10-09-migration-tool-implementation.md` (假设)。

风险：数据完整性 (schema 验证)；备份兼容性 (HF push)；CI 环境 (secrets for tokens)。

## 实施步骤

### 步骤 1: 分析现有代码
- `papersys/migration/legacy.py`：已有 LegacyMigrator, 支持 metadata/embeddings/preferences/summaries 迁移，使用 polars/HF API。CLI app 已存在。已读取并理解。
- `tests/backup/test_backup_service.py`：现有 BackupService 测试，需扩展。
- `tests/migration/test_legacy.py`：现有基本测试，需增强。
- CI：无现有 yaml，需新增 .github/workflows/ci.yml。

### 步骤 2: 扩展 LegacyMigrator
- 添加 publishing/feedback 迁移：
  - _process_publishing(): 迁移 content MD 到 data/publishing/content/。
  - _process_feedback(): 集成 giscus/Notion 数据到 preferences。
- 增强 run(): 添加 schema 验证 (polars schema check)，dry-run 报告。
- 更新 CLI：添加 --publishing, --feedback flags。

### 步骤 3: 创建 scripts/migrate_reference_data.py
- CLI 包装 LegacyMigrator.run()，支持 --dry-run, --force, --year 等参数。
- 示例：`uv run scripts/migrate_reference_data.py --year 2025 --dry-run`。

### 步骤 4: BackupService 测试扩展
- `tests/backup/test_backup_service.py`：新增测试 for summaries.jsonl, preferences.csv, content.md 备份。
- 验证 HF push (mock HfApi)，local backup。

### 步骤 5: 新增 tests/migration/test_legacy.py
- 测试 LegacyMigrator.run() for each module (metadata, embeddings, etc.)。
- Mock HF API, test dry-run output, schema validation。

### 步骤 6: CI 配置
- 创建 .github/workflows/ci.yml：on push/pull_request, run `uv run pytest` (full + directed)，upload coverage。
- Secrets: GITHUB_TOKEN, HF_TOKEN for backup tests。

### 步骤 7: 创建 scripts/run_backup_sample.py
- 示例脚本：BackupService.run() with sample data, log result。
- 支持 --dry-run, --remote hf://dataset。

### 步骤 8: 文档更新
- `devdoc/migration-playbook.md`：步骤指南 for running migration, troubleshooting。
- 本文件：记录执行细节。
- 更新 `devdoc/architecture.md`：添加 migration/backup 流程图。

### 步骤 9: 测试验证
- 运行 `uv run --no-progress pytest tests/migration/ tests/backup/`，确保全绿。
- Dry-run migration：验证报告无错误。
- Backup sample：运行 scripts/run_backup_sample.py，检查 logs。

## 遇到的问题与解决方案
- 问题 1: Schema 不一致 (legacy vs new) - 解决方案：添加 pl.schema validation in _build_*_frame, log warnings。
- 问题 2: HF API rate limit - 解决方案：添加 retry decorator, cache_dir for local。
- 问题 3: CI secrets - 解决方案：使用 GitHub secrets for tokens, conditional skip if not set。
- 问题 4: Backup large files - 解决方案：chunked upload to HF, test with small sample。

## Git 版本管理
- Branch: feature/w7-migration-backup-wrapup
- Commits:
  - "feat: extend LegacyMigrator for publishing/feedback"
  - "feat: add scripts/migrate_reference_data.py CLI"
  - "test: enhance tests/backup and add tests/migration/test_legacy.py"
  - "ci: add .github/workflows/ci.yml for pytest"
  - "feat: add scripts/run_backup_sample.py"
  - "docs: add devdoc/migration-playbook.md"
- 每个 commit 前运行 pytest，确保无回归。

## 收尾与后续计划
- 项目迁移完成：W1-W7 全覆盖，本地优先流水线就绪。
- 验证：运行 full pipeline (scripts/run_real_full_pipeline.py)，检查 data/ 输出。
- 后续：监控 CI, 优化性能 (e.g., parallel ingestion)，用户手册。
- 阻塞解决：所有风险已缓解，代码覆盖 >80%。