# 2025-10-04 Task Reflection: Orchestration failure & recovery plan

Status: In-Progress
Last-updated: 2025-10-04

## 摘要
- 在推进 W5-W8 时一次性合入多项改动，未按计划拆分为可验证的小步骤；测试未全部通过即继续下一个 TODO。
- 未贯彻“少用 mock、以小样本加速”的测试策略；pytest 运行时间未达目标。
- 版本管理不当：缺少细粒度提交/回滚点，影响定位与回退。
- 本文档给出根因分析、风险评估与可执行的修复计划（按最小可行单元拆分，设置明确验收门槛与回滚策略）。

## 相关文档
- 架构与约束：[devdoc/architecture.md](devdoc/architecture.md)
- 运行环境约束：[devdoc/env.md](devdoc/env.md)
- 流程与规范：[devdoc/rool.md](devdoc/rool.md)
- 行为准则与工具约定：[AGENTS.md](AGENTS.md)
- 迁移计划与周目标：[devlog/2025-10-03-migration-plan.md](devlog/2025-10-03-migration-plan.md)

## 现象与影响
- pytest 不稳定且耗时，无法在可接受时长内拿到稳定的绿色结果。
- 部分任务依赖被并行推进，造成接口/目录结构临时不一致，放大联动故障面。
- CI/本地验证缺乏明确的“通过门槛”，导致“未验证即推进”的决策偏差。

## 根因分析（5 Whys）
1. 为什么会一次性推进多任务？——缺少拆分与任务编排检查清单，忽略了“先测后并行”的门槛。
2. 为什么测试耗时未优化？——未执行“小样本替代 mock”的策略，仍默认走网络或大数据路径。
3. 为什么难以回滚？——提交粒度过大、缺少阶段性 tag/branch 保护点。
4. 为什么出现接口不一致？——未设置“跨模块变更需先发计划 devlog 并冻结依赖”的守护栏。
5. 为什么未及时止损？——缺乏“测试未过不得切下一个 TODO”的强制 gate。

## 风险评估
- 连锁回归：接口/路径轻微变化会影响后续阶段（Publishing/Feedback/Scheduler）。
- 数据安全：尽管未观测到生产数据污染，但若继续并行推进，存在写入 data/ 生产路径的风险。
- 团队协作：缺少可回滚的变更单元，阻碍多人并行与代码评审。

## 即刻处置（Freeze & Verify）
- 冻结新增功能开发，直到测试恢复稳定绿色。
- 将所有外部 API 调用设为默认禁用（测试中强制 stub 或小样本离线路径）。
- 仅在 tmp/ 或测试专用目录写入产物；禁止写入 data/ 生产路径。

## 修复计划与拆分执行单
- 执行顺序严格线性；每一小单元必须“用例通过 + 干跑无写入”后，才能开始下一项。

1. 测试基线修复（无功能改动）
   - 目标：恢复 pytest 全绿；将慢测试打标记并可跳过；统一小样本数据路径。
   - 操作：
     - 收集失败用例，按模块定位（ingestion/embedding/recommend/summary/feedback/scheduler）。
     - 用小样本替代 mock：裁剪 CSV/Parquet 到 N≤10；屏蔽网络与真实 LLM。
     - 将外部依赖测试标记为 slow 或 integration，默认不在快速回归中运行。
   - 验收：`uv run --no-progress pytest -q` 用时 < 120s，全部通过。

2. 推荐输出与摘要对接的稳定化
   - 目标：仅验证读/写契约，不做模板或模型变更。
   - 操作：使用固定推荐样本（<=10）跑 SummaryPipeline stub，产出到 tmp/ 并校验 JSONL/MD 对齐。
   - 验收：字段/排序一致；无网络；不写 data/。

3. Publishing 渲染最小化可用
   - 目标：将 Markdown 渲染跑通到 tmp/content/，不接入外部评论源。
   - 操作：Jinja2 模板路径、变量最小校验，确保可重复写入覆盖。
   - 验收：生成 N≤5 的 MD 文件，路径与 front-matter 符合文档。

4. Feedback 抓取的离线演示
   - 目标：仅以假数据/本地缓存演示解析与偏好更新逻辑。
   - 操作：以小 CSV 驱动，验证偏好合并与去重，不触网。
   - 验收：偏好 CSV 更新幂等且可回滚（保留备份文件）。

5. Scheduler 编排最小集合
   - 目标：仅注册作业，不默认启动；/jobs 与 /metrics 可查询但不触发真实任务。
   - 操作：默认禁用所有作业；提供手动触发 dry-run 的入口。
   - 验收：API 返回 200；触发 dry-run 仅打印计划，不落盘。

6. Migration/Backup 校验
   - 目标：迁移工具在 dry-run 下输出报告；BackupService 仅打印备份清单。
   - 操作：以 tmp/ 构造输入，验证 schema 检查与异常报告。
   - 验收：无写 data/；报告包含成功/失败计数。

7. 文档与样例脚本补齐
   - 目标：所有上一步骤均有对应 devlog 与 scripts/ 样例，便于复现。
   - 操作：同步更新 devdoc 与 README 跑法，标注默认 dry-run。
   - 验收：新同学可在 10 分钟内按文档跑通干跑链路。

8. 性能回访与移除临时开关
   - 目标：在稳定的基础上逐步开启真实路径；将慢点标注并移入 nightly。
   - 操作：逐项开启，发现回归立即回滚到上一个 tag。
   - 验收：CI 全绿；慢用例在预期耗时内。

## 验收门槛（Definition of Done）
- 单元/集成测试通过；无网络；用时 < 120s 的快速回归。
- 干跑脚本仅打印或写 tmp/；不污染 data/。
- 有 devlog 记录具体操作、结果与回滚方式。
- Git 提交按任务单元划分；每单元 1~3 个原子提交。

## 回滚策略
- 每个任务单元落地后打轻量 tag（如 v2025-10-04-step1）；问题出现时回滚到最近的绿色 tag。
- 对数据写入类步骤，先写到 tmp/，确认哈希与行数后再迁入正式路径；必要时保留 .bak。

## 任务分发模板（供 orchestrator 派发）
- 标题：<模块>/<功能> 最小化修复（Step X）
- 输入：相关文件/用例/样例数据路径
- 输出：测试通过截图/日志、tmp/ 下产物列表
- 门槛：不得改动非本模块文件；不得写 data/；必须追加/更新测试
- 回滚：恢复到上一个 tag；删除 tmp/ 产物

## 后续行动（今日）
- [ ] 收集并分类当前 pytest 失败清单
- [ ] 设定小样本基准数据（<=10 条）并在 tests/ 下落地
- [ ] 将外部依赖用例标 slow；默认跳过
- [ ] 提交 AGENTS.md 更新，加入更严格的“任务编排纪律”与“测试策略”

附注：对外暴露的接口/命令在未解冻前仅允许 dry-run 使用，真实运行需显式开启并在 devlog 记录。