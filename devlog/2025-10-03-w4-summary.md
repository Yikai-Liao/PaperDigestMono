# 2025-10-03 W4 Summary & Conversion Plan

Status: Completed  
Last-updated: 2025-10-11

## 现状评估
- `SummaryPipeline` 已封装 PDF 获取、LLM 生成与 Markdown 渲染，但缺少与新推荐输出的衔接以及标准化的 JSONL/Markdown 落盘规范。
- CLI 仅提供 `summarize` 命令的 dry-run 提示，尚未串联实际执行、输出目录以及日志/错误捕获策略。
- 缺少最小化运行脚本与测试覆盖真实 PDF/Markdown workflow，难以验证多源数据、失败重试、模板渲染等细节。
- 摘要结果的存储规范（`data/summaries/YYYY-MM.jsonl` 等）尚未在代码层面实现端到端落盘与 manifest 产出。

## 目标与范围
1. 将推荐输出与摘要流水线打通：接受推荐生成的 `recommended.parquet` 或 JSONL 输入，生成对应的 PDF/Markdown/JSONL 摘要。
2. 在 `SummaryPipeline` 中增加结果持久化逻辑（JSONL + Markdown 文件）及伴随的 `manifest.json`，目录规范为 `data/summaries/YYYY-MM/`。
3. CLI `summarize` 命令扩展执行路径：支持从推荐结果加载待摘要列表、控制 dry-run/limit、输出统计。
4. 编写 `scripts/run_summary_sample.py`，提供最小化示例（使用 stub fetcher/LLM）以便快速回归。
5. 完善测试：包括纯单元（stub fetcher/renderer）、端到端小数据集（无真实外部依赖）的聚合测试，覆盖失败重试与文件生成。
6. 更新文档（`devdoc/architecture.md`、`devdoc/data-storage.md`、`devdoc/testing/full-pipeline.md`）并在本日志记录实施情况。

## 实施方案
1. **数据模型与输入适配**
   - 定义 `SummarySource` 构造器从推荐结果（parquet/JSONL）解析需要摘要的字段（paper_id、title、abstract、score等）。
   - 增加辅助函数将推荐 manifest 与摘要任务列表关联，避免重复摘要。
2. **流水线增强**
   - `SummaryPipeline.run()` 增加 JSONL/Markdown 写盘能力，统一路径与文件命名；加入 `manifest.json`（包含任务数、成功/失败、模型信息）。
   - 支持可插拔 fetcher/LLM 实现（真实/Stub），便于测试与离线验证。
   - 增加异常处理与重试统计，确保失败项记录到 manifest。
3. **CLI 与脚本**
   - 扩展 `papersys summarize`：新增 `--input`（推荐输出路径）、`--limit`、`--force` 等参数，默认根据推荐 manifest 选择待处理项。
   - 新增 `scripts/run_summary_sample.py`，在 stub 模式下执行完整流程并打印输出位置。
4. **测试**
   - 更新/新增 `tests/summary` 模块：覆盖 fetcher stub、LLM stub、run 输出文件、manifest 结构等。
   - 为 CLI 与脚本添加最小测试，验证 dry-run、执行模式与错误处理。
5. **文档与记录**
   - 更新数据存储文档描述 `data/summaries/` 结构变化。
   - 在 `devdoc/testing/full-pipeline.md` 记录摘要阶段的测试策略与 stub 依赖。

## 风险与缓解
- 真正拉取 PDF/LLM 成本高且受限：默认使用 stub，通过参数控制真实调用；manifest 记录失败原因便于人工重试。
- 文件落盘量大：通过 `--limit` 控制单次摘要数量，并在 manifest 中记录已处理 ID 以便增量。
- Markdown/JSONL 模板可能导致格式不稳定：集中封装 renderer，提供单元测试校验字段顺序与渲染内容。

## 验证计划
- `uv run --no-progress pytest tests/summary`
- `uv run --no-progress python scripts/run_summary_sample.py --dry-run`
- 视需要运行 `uv run --no-progress python scripts/run_summary_sample.py --limit 5`

## 回滚策略
- 变化集中于 `papersys/summary` 与 CLI/脚本；出现问题可回滚相关提交并恢复旧的 summarize 行为。
- 摘要输出均在新增目录下，如需回滚可手动删除生成的样例文件。

## 实施记录
- `SummaryPipeline` 新增 `run_and_save`、`load_sources_from_recommendations`，自动在 `data/summaries/` 追加 `YYYY-MM.jsonl`、`manifest-<run_id>.json`，Markdown 输出按 `markdown/<run_id>/` 分组。
- `SummarySource` 扩展 `score`/`categories`，JSONL 记录匹配 `SUMMARY_FIELD_ORDER` 的核心字段；manifest 记录成功/失败、LLM 与输出路径。
- CLI `papersys summarize` 支持 `--input`、`--limit`、`--dry-run`，可自动发现最新推荐结果；新增脚本 `scripts/run_summary_sample.py` 便于最小化演示（默认提示缺少真实 API key 时改用 stub 配置）。
- 测试覆盖：`tests/summary/test_summary_pipeline.py`、`tests/summary/test_cli_summarize.py`、`tests/cli/test_cli_commands.py` 增补落盘、CLI 执行与干跑场景。

## 验证结果
- `uv run --no-progress pytest tests/summary/test_summary_pipeline.py`
- `uv run --no-progress pytest tests/summary/test_cli_summarize.py`
- `uv run --no-progress pytest tests/cli/test_cli_commands.py`
- `uv run --no-progress pytest tests/recommend tests/embedding/test_embedding_service.py`（全链路回归）
- `uv run --no-progress env PYTHONPATH=. python scripts/run_summary_sample.py --dry-run`（需配置 stub 或有效 `GEMINI_API_KEY`）

## 运行结论
- 摘要流水线现可直接消费推荐产出并生成 JSONL/Markdown/manifest；CLI/脚本支持干跑与限量执行，测试确认无外部依赖时使用 Stub fetcher/LLM 正常落盘。
